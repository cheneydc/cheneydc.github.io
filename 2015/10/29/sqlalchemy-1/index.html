<!DOCTYPE html>
<html lang="zh-cn">
  <head>
    
<meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>


<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">



  <meta name="description" content="SQLalchemmy - 1"/>













  <link rel="alternate" href="/default" title="种葱得葱">




  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=2.6.0" />



<link rel="canonical" href="http://cheneydc.me/2015/10/29/sqlalchemy-1/"/>


<link rel="stylesheet" type="text/css" href="/css/style.css?v=2.6.0" />



  <link rel="stylesheet" type="text/css" href="/lib/fancybox/jquery.fancybox.css" />




  



  <script id="baidu_push">
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
    }
    else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>









    <title> SQLalchemmy - 1 - 种葱得葱 </title>
  <link rel="stylesheet" href="/css/prism.css" type="text/css">
<link rel="stylesheet" href="/css/prism-line-numbers.css" type="text/css"></head>

  <body><div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/." class="logo">种葱得葱</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>

<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    
      <a href="/">
        <li class="mobile-menu-item">
          
          
            首页
          
        </li>
      </a>
    
      <a href="/archives/">
        <li class="mobile-menu-item">
          
          
            归档
          
        </li>
      </a>
    
      <a href="/tags">
        <li class="mobile-menu-item">
          
          
            标签
          
        </li>
      </a>
    
      <a href="/categories">
        <li class="mobile-menu-item">
          
          
            分类
          
        </li>
      </a>
    
      <a href="/about">
        <li class="mobile-menu-item">
          
          
            关于
          
        </li>
      </a>
    
  </ul>
</nav>

    <div class="container" id="mobile-panel">
      <header id="header" class="header"><div class="logo-wrapper">
  <a href="/." class="logo">种葱得葱</a>
</div>

<nav class="site-navbar">
  
    <ul id="menu" class="menu">
      
        <li class="menu-item">
          <a class="menu-item-link" href="/">
            
            
              首页
            
          </a>
        </li>
      
        <li class="menu-item">
          <a class="menu-item-link" href="/archives/">
            
            
              归档
            
          </a>
        </li>
      
        <li class="menu-item">
          <a class="menu-item-link" href="/tags">
            
            
              标签
            
          </a>
        </li>
      
        <li class="menu-item">
          <a class="menu-item-link" href="/categories">
            
            
              分类
            
          </a>
        </li>
      
        <li class="menu-item">
          <a class="menu-item-link" href="/about">
            
            
              关于
            
          </a>
        </li>
      
    </ul>
  
</nav>

      </header>

      <main id="main" class="main">
        <div class="content-wrapper">
          <div id="content" class="content">
            
  
  <article class="post">
    <header class="post-header">
      <h1 class="post-title">
        
          SQLalchemmy - 1
        
      </h1>

      <div class="post-meta">
        <span class="post-time">
          2015-10-29
        </span>
        
          <div class="post-category">
            
              <a href="/categories/技术/">技术</a>
            
          </div>
        
        
      </div>
    </header>

    
    
  <div class="post-toc" id="post-toc">
    <h2 class="post-toc-title">文章目录</h2>
    <div class="post-toc-content">
      <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#安装："><span class="toc-text">安装：</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#1-连接数据库"><span class="toc-text">1 连接数据库</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#2-定义数据库样式"><span class="toc-text">2 定义数据库样式</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#3-创建实例"><span class="toc-text">3 创建实例</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#4-创建Session"><span class="toc-text">4 创建Session</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#5-添加对象"><span class="toc-text">5 添加对象</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#6-回滚"><span class="toc-text">6 回滚</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#7-查询"><span class="toc-text">7 查询</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#常用筛选操作"><span class="toc-text">常用筛选操作</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#返回列表和标量"><span class="toc-text">返回列表和标量</span></a></li></ol></li></ol>
    </div>
  </div>


    <div class="post-content">
      
        <p>Openstack最近看的有点乱套了，openstack组件都是利用sqlalchemy来操作数据库的，赶上这个机会就看看了。</p>
<p><a href="http://docs.sqlalchemy.org/en/rel_1_0/orm/tutorial.html" target="_blank" rel="noopener">官方文档</a></p>
<p>SQLAlchemy是ORM框架的一种，可以将Python中的类和数据库中的表进行映射，并将类的实例和表数据库表中的数据进行对应。 这样一个抽象的数据库表我们就可以很方便的通过一个类来记录和操作了。</p>
<a id="more"></a>
<h1 id="安装："><a href="#安装：" class="headerlink" title="安装："></a>安装：</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># pip install sqlalchemy</span></span><br></pre></td></tr></table></figure>
<h1 id="1-连接数据库"><a href="#1-连接数据库" class="headerlink" title="1 连接数据库"></a>1 连接数据库</h1><p>通过<code>create_engine()</code>可以连接到数据库:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">form sqlalchemy <span class="keyword">import</span> create_engine</span><br><span class="line">engine = create_engine(<span class="string">'sqlite:///:memory:'</span>, echo=<span class="keyword">True</span>)</span><br></pre></td></tr></table></figure>
<p><code>echo</code>用来设置SQLAlchemy日志，通过python的logging模块实现，如果不需要则设置为<code>False</code>。通过调用<code>create_engine()</code>得到的engine是<code>Engine</code>的一个实例，包含了连接数据库的主要接口。</p>
<p>实际上我们得到engine的时候并没有真正的连接数据库，这里采用的是lazy connecting的方式，真正连接数据库的操作发生在我们第一次访问数据库执行操作的时候。</p>
<h1 id="2-定义数据库样式"><a href="#2-定义数据库样式" class="headerlink" title="2 定义数据库样式"></a>2 定义数据库样式</h1><p>使用ORM的话，首先我们先要确定数据库表的样式，由于表和python中的类是对应的，这里我们需要定义相应的类。 这种映射关系的类我们需要通过Declarative系统中的<code>declarative base class</code>这个基类来实现。我们可以通过<code>declarative_base()</code>函数获得：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> sqlalchemy.ext.declarative <span class="keyword">import</span> declarative_base</span><br><span class="line"></span><br><span class="line">Base = declarative_base()</span><br></pre></td></tr></table></figure>
<p>这样我们就得到了一个可以实现表-类映射关系的基类。我们尝试创建一个表<code>users</code>，保存用户信息。创建类<code>User</code>来与这个表进行关联。类中我们首先将这个表与之关联，随后定义相应的变量名和相应的类型。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> sqlalchemy.ext.declarative <span class="keyword">import</span> declarative_base</span><br><span class="line"><span class="keyword">from</span> sqlalchemy <span class="keyword">import</span> create_engine</span><br><span class="line"><span class="keyword">from</span> sqlalchemy <span class="keyword">import</span> Column, Integer, String</span><br><span class="line"></span><br><span class="line">Base = declarative_base()</span><br><span class="line"></span><br><span class="line">engine = create_engine(<span class="string">'sqlite:///memory:'</span>, echo=<span class="keyword">True</span>)</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span><span class="params">(Base)</span>:</span></span><br><span class="line">    __tablename__ = <span class="string">'users'</span></span><br><span class="line"></span><br><span class="line">    id  = Column(Integer, primary_key=<span class="keyword">True</span>)</span><br><span class="line">    name = Column(String)</span><br><span class="line">    fullname = Column(String)</span><br><span class="line">    password = Column(String)</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__repr__</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">"&lt;User(name='%s', fullname='%s', password='%s')&gt;"</span> %(</span><br><span class="line">                        self.name, self.fullname, self.password</span><br><span class="line">                        )</span><br></pre></td></tr></table></figure>
<p>方法<strong>repr</strong>()是为了方便的显示格式，不是必须的</p>
<p>类中必须有<code>_tablename_</code>属性，至少一个primary key的<code>Column</code>。</p>
<p>SQLAlchemy never makes any assumptions by itself about the table to which a class refers, including that it has no built-in conventions for names, datatypes, or constraints. But this doesn’t mean boilerplate is required; instead, you’re encouraged to create your own automated conventions using helper functions and mixin classes, which is described in detail at <a href="http://docs.sqlalchemy.org/en/rel_1_0/orm/extensions/declarative/mixins.html#declarative-mixins" target="_blank" rel="noopener">Mixin and Custom Base Classes</a>.</p>
<p>我们通过Declarative系统创建了<code>User</code>类，在类中我们定义了表相关的信息，也就是表的元数据。SQLAlchemy中有一个<code>Table</code>对象来表示这些信息，通过<code>__table__</code>属性可以得到。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>User.__table__</span><br><span class="line">Table(<span class="string">'users'</span>, MetaData(bind=<span class="keyword">None</span>), Column(<span class="string">'id'</span>, Integer(), table=&lt;users&gt;, primary_key=<span class="keyword">True</span>, nullable=<span class="keyword">False</span>), Column(<span class="string">'name'</span>, String(), table=&lt;users&gt;), Column(<span class="string">'fullname'</span>, String(), table=&lt;users&gt;), Column(<span class="string">'password'</span>, String(), table=&lt;users&gt;), schema=<span class="keyword">None</span>)</span><br></pre></td></tr></table></figure>
<p><code>Table</code>对象是<code>MetaData</code>的一部分，Metadata是Table的集合。Metadata可以发送一些命令在数据库中执行。现在我们的SQLite数据库中实际上还没有<code>users</code>表。调用<code>MetaData.create_all()</code>方法，将我们的数据库连接engine作为参数传给它。首先执行的命令是查看<code>users</code>是否存在，然后是创建表的语句<code>CREATE_TABLE</code>:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt;Base.metadata.create_all(engine)</span><br><span class="line"><span class="number">2015</span><span class="number">-10</span><span class="number">-29</span> <span class="number">17</span>:<span class="number">36</span>:<span class="number">41</span>,<span class="number">372</span> INFO sqlalchemy.engine.base.Engine SELECT CAST(<span class="string">'test plain returns'</span> AS VARCHAR(<span class="number">60</span>)) AS anon_1</span><br><span class="line"><span class="number">2015</span><span class="number">-10</span><span class="number">-29</span> <span class="number">17</span>:<span class="number">36</span>:<span class="number">41</span>,<span class="number">374</span> INFO sqlalchemy.engine.base.Engine ()</span><br><span class="line"><span class="number">2015</span><span class="number">-10</span><span class="number">-29</span> <span class="number">17</span>:<span class="number">36</span>:<span class="number">41</span>,<span class="number">375</span> INFO sqlalchemy.engine.base.Engine SELECT CAST(<span class="string">'test unicode returns'</span> AS VARCHAR(<span class="number">60</span>)) AS anon_1</span><br><span class="line"><span class="number">2015</span><span class="number">-10</span><span class="number">-29</span> <span class="number">17</span>:<span class="number">36</span>:<span class="number">41</span>,<span class="number">375</span> INFO sqlalchemy.engine.base.Engine ()</span><br><span class="line"><span class="number">2015</span><span class="number">-10</span><span class="number">-29</span> <span class="number">17</span>:<span class="number">36</span>:<span class="number">41</span>,<span class="number">377</span> INFO sqlalchemy.engine.base.Engine PRAGMA table_info(<span class="string">"users"</span>)</span><br><span class="line"><span class="number">2015</span><span class="number">-10</span><span class="number">-29</span> <span class="number">17</span>:<span class="number">36</span>:<span class="number">41</span>,<span class="number">378</span> INFO sqlalchemy.engine.base.Engine ()</span><br><span class="line"><span class="number">2015</span><span class="number">-10</span><span class="number">-29</span> <span class="number">17</span>:<span class="number">36</span>:<span class="number">41</span>,<span class="number">379</span> INFO sqlalchemy.engine.base.Engine</span><br><span class="line">CREATE TABLE users (</span><br><span class="line">        id INTEGER NOT NULL,</span><br><span class="line">        name VARCHAR,</span><br><span class="line">        fullname VARCHAR,</span><br><span class="line">        password VARCHAR,</span><br><span class="line">        PRIMARY KEY (id)</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="number">2015</span><span class="number">-10</span><span class="number">-29</span> <span class="number">17</span>:<span class="number">36</span>:<span class="number">41</span>,<span class="number">379</span> INFO sqlalchemy.engine.base.Engine ()</span><br><span class="line"><span class="number">2015</span><span class="number">-10</span><span class="number">-29</span> <span class="number">17</span>:<span class="number">36</span>:<span class="number">41</span>,<span class="number">410</span> INFO sqlalchemy.engine.base.Engine COMMIT</span><br></pre></td></tr></table></figure>
<hr>
<p><strong>Minimal Table Descriptions vs. Full Descriptions</strong> 熟悉CREATE_TABLE的可以看出来VARCHAR这里是没有长度的，对于数据库SQLite和Postgresql，这是允许的，但是其他的一些数据库，这个不可以的。所以如果要正确执行需要指定String的长度：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Column(String(<span class="number">50</span>))</span><br></pre></td></tr></table></figure>
<p>Firebird和Oracle会要求给主键设定sequences，SQLAlchemy在没有明确制定的情况下是不指定的，需要的话需要自己指定：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> sqlalchemy <span class="keyword">import</span> Sequence</span><br><span class="line">Column(Integer, Sequence(<span class="string">'user_id_seq'</span>), primary_key=<span class="keyword">True</span>)</span><br></pre></td></tr></table></figure>
<p>所以一个完整的定义应该像这样：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> sqlalchemy.ext.declarative <span class="keyword">import</span> declarative_base</span><br><span class="line"><span class="keyword">from</span> sqlalchemy <span class="keyword">import</span> Column, Integer, String, create_engine, Sequence</span><br><span class="line"></span><br><span class="line">Base = declarative_base()</span><br><span class="line"></span><br><span class="line">engine = create_engine(<span class="string">'sqlite:///memory:'</span>, echo=<span class="keyword">True</span>)</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span><span class="params">(Base)</span>:</span></span><br><span class="line">    __tablename__ = <span class="string">'users'</span></span><br><span class="line"></span><br><span class="line">    id  = Column(Integer, Sequence(<span class="string">'user_id_seq'</span>), primary_key=<span class="keyword">True</span>)</span><br><span class="line">    name = Column(String(<span class="number">60</span>))</span><br><span class="line">    fullname = Column(String(<span class="number">60</span>))</span><br><span class="line">    password = Column(String(<span class="number">16</span>))</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__repr__</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">"&lt;User(name='%s', fullname='%s', password='%s')&gt;"</span> %(</span><br><span class="line">                        self.name, self.fullname, self.password</span><br><span class="line">                        )</span><br></pre></td></tr></table></figure>
<hr>
<h1 id="3-创建实例"><a href="#3-创建实例" class="headerlink" title="3 创建实例"></a>3 创建实例</h1><p>与数据库中的表相关的类我们已经创建好了，下面创建一个实例：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">user_1 = User(name=<span class="string">'dc'</span>, fullname=<span class="string">'cheneydc'</span>, password=<span class="string">'nopassword'</span>)</span><br><span class="line"><span class="keyword">print</span> <span class="string">"user name is:    %s"</span>  % (user_1.name)</span><br><span class="line"><span class="keyword">print</span> <span class="string">"user id is:      %s"</span>  % (str(user_1.id))</span><br></pre></td></tr></table></figure>
<p>执行后的结果：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">user name is:    dc</span><br><span class="line">user id is:      None</span><br></pre></td></tr></table></figure>
<p>这里我们没有给id一个值，但id这里是<code>None</code>（Python通常对没有定义的属性会报AttributeError错误）。SQLAlchemy的<a href="http://docs.sqlalchemy.org/en/rel_1_0/glossary.html#term-instrumentation" target="_blank" rel="noopener">instrumentation</a> 在第一次访问的时候会为这些和数据库表有映射关系的属性一个默认值。对于我们已经赋值的属性，<code>instrument</code>系统会跟踪赋值的过程直到最后的INSERT语句在数据库中执行。</p>
<h1 id="4-创建Session"><a href="#4-创建Session" class="headerlink" title="4 创建Session"></a>4 创建Session</h1><p>到这里我们就可以开始与数据库交互了。ORM与数据库进行交互的句柄就是<code>Session</code>。在程序的开头，create_engine()的地方，我们定义一个<code>Session</code>类，通过它来创建session。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> sqlalchemy.orm <span class="keyword">import</span> sessionmaker</span><br><span class="line">Session = sessionmaker(bind=engine)</span><br></pre></td></tr></table></figure>
<p>如果程序还没有创建engine的情况下，可以只这样写：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Session = sessionmaker()</span><br></pre></td></tr></table></figure>
<p>随后创建好engine可以用<code>configure()</code>进行关联：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Session.cinfigure(bind=engine)</span><br></pre></td></tr></table></figure>
<p>这样一个Session类创建的session对象都是与我们的数据绑定的。想要操作数据库的话就需要创建一个session对象：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">session = Session()</span><br></pre></td></tr></table></figure>
<p>上面创建的session就与数据库相关联了，但像我们上面说的，并没有真正的与数据库建立市实际的连接，第一次操作数据库的时候连接才被建立，直到提交了所有变更或者关闭了session对象。</p>
<h1 id="5-添加对象"><a href="#5-添加对象" class="headerlink" title="5 添加对象"></a>5 添加对象</h1><p>为了保存User对象，我们需要将对象添加到Session中：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>user_2 = User(name=<span class="string">'cc'</span>, fullname=<span class="string">'cheney'</span>, password=<span class="string">'no'</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>session.add(user_2)</span><br></pre></td></tr></table></figure>
<p>这个时候，实际上SQL语句没有执行，对象也没有被实际写入到数据库中，session实例处于<strong>pending</strong>状态，只有执行了<strong>flush</strong>操作后，Session才会将对象写入数据库。如果当我们执行在数据库中查找<code>user_2</code>的操作的时候，所有的<code>pending</code>状态的数据会首先被<code>flushed</code>，之后才会执行查找。</p>
<p>比如我们创建一个<code>Query</code>对象并加载<code>User</code>。指定查找<code>name</code>为<code>cc</code>的用户，指明只需要查找结果中的第一个。查找结果就返回一个我们添加的<code>User</code>实例：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>query_user = session.query(User).filter_by(name=<span class="string">'cc'</span>).first()</span><br><span class="line"><span class="number">2015</span><span class="number">-11</span><span class="number">-02</span> <span class="number">10</span>:<span class="number">15</span>:<span class="number">10</span>,<span class="number">865</span> INFO sqlalchemy.engine.base.Engine SELECT users.id AS users_id, users.name AS users_name, users.fullname AS users_fullname, users.password AS users_password</span><br><span class="line">FROM users</span><br><span class="line">WHERE users.name = ?</span><br><span class="line"> LIMIT ? OFFSET ?</span><br><span class="line"><span class="number">2015</span><span class="number">-11</span><span class="number">-02</span> <span class="number">10</span>:<span class="number">15</span>:<span class="number">10</span>,<span class="number">865</span> INFO sqlalchemy.engine.base.Engine (<span class="string">'cc'</span>, <span class="number">1</span>, <span class="number">0</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>query_user <span class="keyword">is</span> user_2</span><br><span class="line"><span class="keyword">True</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>query_user</span><br><span class="line">&lt;User(name=<span class="string">'cc'</span>, fullname=<span class="string">'cheney'</span>, password=<span class="string">'no'</span>)&gt;</span><br></pre></td></tr></table></figure>
<p>实际上Session识别出返回的row和内部映射的对象中的一个是一样的（我们刚刚添加的一个对象），所以实际上我们得到的是和添加的同一个对象。</p>
<p>对于一个在Session中存在的primary key，所有在session中查询这个key，都会返回这个特定key的Python对象。</p>
<p>我们可以用add_all添加多个User对象：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>user_3 = User(name=<span class="string">'ed'</span>, fullname=<span class="string">'eeeddd'</span>, password=<span class="string">'qweasd'</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>user_4 = User(name=<span class="string">'zxc'</span>, fullname=<span class="string">'zxcvasdf'</span>, password=<span class="string">'098765'</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>session.add_all([user_3, user_4])</span><br></pre></td></tr></table></figure>
<p>我们对已经添加的对象做一些修改：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>user_1.password = <span class="string">"123456"</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>user_2.name=<span class="string">'ccc'</span></span><br></pre></td></tr></table></figure>
<p>Session会记录这些修改，新添加的对象记录在new属性中，修改过的对象记录在dirty中：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>session.new</span><br><span class="line">IdentitySet([&lt;User(name=<span class="string">'ed'</span>, fullname=<span class="string">'eeeddd'</span>, password=<span class="string">'qweasd'</span>)&gt;, &lt;User(name=<span class="string">'zxc'</span>, fullname=<span class="string">'zxcvasdf'</span>, password=<span class="string">'098765'</span>)&gt;])</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>session.dirty</span><br><span class="line">IdentitySet([&lt;User(name=<span class="string">'dc'</span>, fullname=<span class="string">'cheneydc'</span>, password=<span class="string">'123456'</span>)&gt;, &lt;User(name=<span class="string">'ccc'</span>, fullname=<span class="string">'cheney'</span>, password=<span class="string">'no'</span>)&gt;])</span><br></pre></td></tr></table></figure>
<p>通过commit()，session会提交所有的更改，并结束与数据库的交互。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>session.commit()</span><br></pre></td></tr></table></figure>
<p>commit()会对所有的更改做flush操作，然后结束与数据库的事务（这里是transaction ，而不是前面说的engine的连接）。后续有其他操作的话实际都是发生在一个新的事务上，操作之前会首先自动连接数据库并获取相关资源。</p>
<h1 id="6-回滚"><a href="#6-回滚" class="headerlink" title="6 回滚"></a>6 回滚</h1><p>由于Session的操作都是在事务（transaction）内执行的，在这个事务结束之前，我们也可以执行回滚操作。现在对对象做一些更改：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>user_1.name=<span class="string">'dongcong'</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>session.dirty</span><br><span class="line">IdentitySet([&lt;User(name=<span class="string">'dongcong'</span>, fullname=<span class="string">'cheneydc'</span>, password=<span class="string">'123456'</span>)&gt;])</span><br></pre></td></tr></table></figure>
<p>添加一个新对象：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>fake_user = User(name=<span class="string">'fake'</span>, fullname=<span class="string">'TestUser'</span>, password=<span class="string">"Nopassword"</span>)  </span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>session.add(fake_user)</span><br></pre></td></tr></table></figure>
<p>然后执行一个查询操作，使更改有效的写入当前的事务中：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>session.query(User).filter(User.name.in_([<span class="string">'dongcong'</span>, <span class="string">'fake'</span>])).all()</span><br><span class="line">2015-11-02 11:11:37,085 INFO sqlalchemy.engine.base.Engine UPDATE users SET name=? WHERE users.id = ?</span><br><span class="line"><span class="number">2015</span><span class="number">-11</span><span class="number">-02</span> <span class="number">11</span>:<span class="number">11</span>:<span class="number">37</span>,<span class="number">085</span> INFO sqlalchemy.engine.base.Engine (<span class="string">'dongcong'</span>, <span class="number">1</span>)</span><br><span class="line">2015-11-02 11:11:37,087 INFO sqlalchemy.engine.base.Engine INSERT INTO users (name, fullname, password) VALUES (?, ?, ?)</span><br><span class="line"><span class="number">2015</span><span class="number">-11</span><span class="number">-02</span> <span class="number">11</span>:<span class="number">11</span>:<span class="number">37</span>,<span class="number">088</span> INFO sqlalchemy.engine.base.Engine (<span class="string">'fake'</span>, <span class="string">'TestUser'</span>, <span class="string">'Nopassword'</span>)</span><br><span class="line"><span class="number">2015</span><span class="number">-11</span><span class="number">-02</span> <span class="number">11</span>:<span class="number">11</span>:<span class="number">37</span>,<span class="number">091</span> INFO sqlalchemy.engine.base.Engine SELECT users.id AS users_id, users.name AS users_name, users.fullname AS users_fullname, users.password AS users_password</span><br><span class="line">FROM users</span><br><span class="line">WHERE users.name IN (?, ?)</span><br><span class="line"><span class="number">2015</span><span class="number">-11</span><span class="number">-02</span> <span class="number">11</span>:<span class="number">11</span>:<span class="number">37</span>,<span class="number">092</span> INFO sqlalchemy.engine.base.Engine (<span class="string">'dongcong'</span>, <span class="string">'fake'</span>)</span><br><span class="line">[&lt;User(name=<span class="string">'dongcong'</span>, fullname=<span class="string">'cheneydc'</span>, password=<span class="string">'123456'</span>)&gt;, &lt;User(name=<span class="string">'fake'</span>, fullname=<span class="string">'TestUser'</span>, password=<span class="string">'Nopassword'</span>)&gt;]</span><br></pre></td></tr></table></figure>
<p>目前，事务还没有结束，执行回滚操作:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>session.rollback()</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>user_1.name</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>dc</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>fake_user <span class="keyword">in</span> session</span><br><span class="line"><span class="keyword">False</span></span><br></pre></td></tr></table></figure>
<h1 id="7-查询"><a href="#7-查询" class="headerlink" title="7 查询"></a>7 查询</h1><p>查询对象是通过Session中的<a href="http://docs.sqlalchemy.org/en/rel_1_0/orm/session_api.html#sqlalchemy.orm.session.Session.query" target="_blank" rel="noopener">query()</a>方法创建的。采用的是可变数量的参数，任意数目的类实体或者基于列的实体均可以作为query()方法的参数<code>can be any combination of classes and class-instrumented descriptors</code>。下面加载User实例进行查询:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">for</span> instance <span class="keyword">in</span> session.query(User).order_by(User.id):</span><br><span class="line"><span class="meta">... </span>    <span class="keyword">print</span> instance.name, instance.fullname</span><br><span class="line">...</span><br><span class="line"><span class="number">2015</span><span class="number">-11</span><span class="number">-02</span> <span class="number">13</span>:<span class="number">20</span>:<span class="number">31</span>,<span class="number">632</span> INFO sqlalchemy.engine.base.Engine SELECT users.id AS users_id, users.name AS users_name, users.fullname AS users_fullname, users.password AS users_password</span><br><span class="line">FROM users ORDER BY users.id</span><br><span class="line"><span class="number">2015</span><span class="number">-11</span><span class="number">-02</span> <span class="number">13</span>:<span class="number">20</span>:<span class="number">31</span>,<span class="number">633</span> INFO sqlalchemy.engine.base.Engine ()</span><br><span class="line">aaa cheneydc</span><br><span class="line">ccc cheney</span><br><span class="line">ed eeeddd</span><br><span class="line">zxwer zxcvasdf</span><br><span class="line">fake TestUser</span><br></pre></td></tr></table></figure>
<p>这个例子中返回的是一组可迭代的User列表，然后通过for…in…语句输出name和fullname，如果不关心其他属性，也可以直接查询想要的类属性，前提是这个类需要时ORM映射的：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">for</span> name,fullname <span class="keyword">in</span> session.query(User.name, User.fullname).all():</span><br><span class="line"><span class="meta">... </span>    <span class="keyword">print</span> name, fullname</span><br><span class="line">...</span><br><span class="line"><span class="number">2015</span><span class="number">-11</span><span class="number">-02</span> <span class="number">15</span>:<span class="number">16</span>:<span class="number">20</span>,<span class="number">691</span> INFO sqlalchemy.engine.base.Engine SELECT users.name AS users_name, users.fullname AS users_fullname</span><br><span class="line">FROM users</span><br><span class="line"><span class="number">2015</span><span class="number">-11</span><span class="number">-02</span> <span class="number">15</span>:<span class="number">16</span>:<span class="number">20</span>,<span class="number">691</span> INFO sqlalchemy.engine.base.Engine ()</span><br><span class="line">aaa cheneydc</span><br><span class="line">ccc cheney</span><br><span class="line">ed eeeddd</span><br><span class="line">zxwer zxcvasdf</span><br><span class="line">fake TestUser</span><br></pre></td></tr></table></figure>
<p>返回的仍然是元组（基于KeyedTuple类），可以当做普通的Python对象对待。属性名称归属性名称，类型名称归类型名称：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">for</span> row <span class="keyword">in</span> session.query(User, User.name).all():</span><br><span class="line"><span class="meta">... </span>    <span class="keyword">print</span> row</span><br><span class="line">...</span><br><span class="line"><span class="number">2015</span><span class="number">-11</span><span class="number">-02</span> <span class="number">15</span>:<span class="number">35</span>:<span class="number">17</span>,<span class="number">303</span> INFO sqlalchemy.engine.base.Engine SELECT users.id AS users_id, users.name AS users_name, users.fullname AS users_fullname, users.password AS users_password</span><br><span class="line">FROM users</span><br><span class="line"><span class="number">2015</span><span class="number">-11</span><span class="number">-02</span> <span class="number">15</span>:<span class="number">35</span>:<span class="number">17</span>,<span class="number">303</span> INFO sqlalchemy.engine.base.Engine ()</span><br><span class="line">(&lt;User(name=<span class="string">'aaa'</span>, fullname=<span class="string">'cheneydc'</span>, password=<span class="string">'123456'</span>)&gt;, <span class="string">u'aaa'</span>)</span><br><span class="line">(&lt;User(name=<span class="string">'ccc'</span>, fullname=<span class="string">'cheney'</span>, password=<span class="string">'no'</span>)&gt;, <span class="string">u'ccc'</span>)</span><br><span class="line">(&lt;User(name=<span class="string">'ed'</span>, fullname=<span class="string">'eeeddd'</span>, password=<span class="string">'qweasd'</span>)&gt;, <span class="string">u'ed'</span>)</span><br><span class="line">(&lt;User(name=<span class="string">'zxwer'</span>, fullname=<span class="string">'zxcvasdf'</span>, password=<span class="string">'098765'</span>)&gt;, <span class="string">u'zxwer'</span>)</span><br><span class="line">(&lt;User(name=<span class="string">'fake'</span>, fullname=<span class="string">'TestUser'</span>, password=<span class="string">'Nopassword'</span>)&gt;, <span class="string">u'fake'</span>)</span><br></pre></td></tr></table></figure>
<p>也可以通过label()方法来改变列表达式的名称:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">for</span> row <span class="keyword">in</span> session.query(User.name.label(<span class="string">'name_label'</span>)).all():</span><br><span class="line"><span class="meta">... </span>    <span class="keyword">print</span> row.name_label</span><br><span class="line">...</span><br><span class="line"><span class="number">2015</span><span class="number">-11</span><span class="number">-02</span> <span class="number">15</span>:<span class="number">37</span>:<span class="number">48</span>,<span class="number">805</span> INFO sqlalchemy.engine.base.Engine SELECT users.name AS name_label</span><br><span class="line">FROM users</span><br><span class="line"><span class="number">2015</span><span class="number">-11</span><span class="number">-02</span> <span class="number">15</span>:<span class="number">37</span>:<span class="number">48</span>,<span class="number">806</span> INFO sqlalchemy.engine.base.Engine ()</span><br><span class="line">aaa</span><br><span class="line">ccc</span><br><span class="line">ed</span><br><span class="line">zxwer</span><br><span class="line">fake</span><br></pre></td></tr></table></figure>
<p>可以发现每次查询都会用到实体类的名称User，可以用aliased()给它一个别名：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">for</span> row <span class="keyword">in</span> session.query(user_alias, user_alias.name).all():</span><br><span class="line"><span class="meta">... </span>    <span class="keyword">print</span> row</span><br><span class="line">...</span><br><span class="line"><span class="number">2015</span><span class="number">-11</span><span class="number">-02</span> <span class="number">15</span>:<span class="number">42</span>:<span class="number">58</span>,<span class="number">489</span> INFO sqlalchemy.engine.base.Engine SELECT user_alias.id AS user_alias_id, user_alias.name AS user_alias_name, user_alias.fullname AS user_alias_fullname, user_alias.password AS user_alias_password</span><br><span class="line">FROM users AS user_alias</span><br><span class="line"><span class="number">2015</span><span class="number">-11</span><span class="number">-02</span> <span class="number">15</span>:<span class="number">42</span>:<span class="number">58</span>,<span class="number">489</span> INFO sqlalchemy.engine.base.Engine ()</span><br><span class="line">(&lt;User(name=<span class="string">'aaa'</span>, fullname=<span class="string">'cheneydc'</span>, password=<span class="string">'123456'</span>)&gt;, <span class="string">u'aaa'</span>)</span><br><span class="line">(&lt;User(name=<span class="string">'ccc'</span>, fullname=<span class="string">'cheney'</span>, password=<span class="string">'no'</span>)&gt;, <span class="string">u'ccc'</span>)</span><br><span class="line">(&lt;User(name=<span class="string">'ed'</span>, fullname=<span class="string">'eeeddd'</span>, password=<span class="string">'qweasd'</span>)&gt;, <span class="string">u'ed'</span>)</span><br><span class="line">(&lt;User(name=<span class="string">'zxwer'</span>, fullname=<span class="string">'zxcvasdf'</span>, password=<span class="string">'098765'</span>)&gt;, <span class="string">u'zxwer'</span>)</span><br><span class="line">(&lt;User(name=<span class="string">'fake'</span>, fullname=<span class="string">'TestUser'</span>, password=<span class="string">'Nopassword'</span>)&gt;, <span class="string">u'fake'</span>)</span><br></pre></td></tr></table></figure>
<p>LIMIT和OFFSET经常用来控制查询的数量和位置，这个可以很方便的用Python中的数组分页与ORDER BY组合完成：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">for</span> row <span class="keyword">in</span> session.query(User).order_by(User.id):</span><br><span class="line"><span class="meta">... </span>    <span class="keyword">print</span> row</span><br><span class="line">...</span><br><span class="line"><span class="number">2015</span><span class="number">-11</span><span class="number">-02</span> <span class="number">15</span>:<span class="number">53</span>:<span class="number">40</span>,<span class="number">182</span> INFO sqlalchemy.engine.base.Engine SELECT users.id AS users_id, users.name AS users_name, users.fullname AS users_fullname, users.password AS users_password FROM users ORDER BY users.id</span><br><span class="line"><span class="number">2015</span><span class="number">-11</span><span class="number">-02</span> <span class="number">15</span>:<span class="number">53</span>:<span class="number">40</span>,<span class="number">182</span> INFO sqlalchemy.engine.base.Engine ()</span><br><span class="line">&lt;User(name=<span class="string">'aaa'</span>, fullname=<span class="string">'cheneydc'</span>, password=<span class="string">'123456'</span>)&gt;</span><br><span class="line">&lt;User(name=<span class="string">'ccc'</span>, fullname=<span class="string">'cheney'</span>, password=<span class="string">'no'</span>)&gt;</span><br><span class="line">&lt;User(name=<span class="string">'ed'</span>, fullname=<span class="string">'eeeddd'</span>, password=<span class="string">'qweasd'</span>)&gt;</span><br><span class="line">&lt;User(name=<span class="string">'zxwer'</span>, fullname=<span class="string">'zxcvasdf'</span>, password=<span class="string">'098765'</span>)&gt;</span><br><span class="line">&lt;User(name=<span class="string">'fake'</span>, fullname=<span class="string">'TestUser'</span>, password=<span class="string">'Nopassword'</span>)&gt;</span><br><span class="line"></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">for</span> row <span class="keyword">in</span> session.query(User).order_by(User.id)[<span class="number">1</span>:<span class="number">3</span>]:</span><br><span class="line"><span class="meta">... </span>    <span class="keyword">print</span> row</span><br><span class="line">...</span><br><span class="line"><span class="number">2015</span><span class="number">-11</span><span class="number">-02</span> <span class="number">15</span>:<span class="number">54</span>:<span class="number">01</span>,<span class="number">541</span> INFO sqlalchemy.engine.base.Engine SELECT users.id AS users_id, users.name AS users_name, users.fullname AS users_fullname, users.password AS users_password</span><br><span class="line">FROM users ORDER BY users.id</span><br><span class="line"> LIMIT ? OFFSET ?</span><br><span class="line"><span class="number">2015</span><span class="number">-11</span><span class="number">-02</span> <span class="number">15</span>:<span class="number">54</span>:<span class="number">01</span>,<span class="number">542</span> INFO sqlalchemy.engine.base.Engine (<span class="number">2</span>, <span class="number">1</span>)</span><br><span class="line">&lt;User(name=<span class="string">'ccc'</span>, fullname=<span class="string">'cheney'</span>, password=<span class="string">'no'</span>)&gt;</span><br><span class="line">&lt;User(name=<span class="string">'ed'</span>, fullname=<span class="string">'eeeddd'</span>, password=<span class="string">'qweasd'</span>)&gt;</span><br></pre></td></tr></table></figure>
<p>筛选的功能通过filter_by()实现，使用关键词参数：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">for</span> row <span class="keyword">in</span> session.query(User).filter_by(fullname=<span class="string">'cheney'</span>):</span><br><span class="line"><span class="meta">... </span>    <span class="keyword">print</span> row</span><br><span class="line">...</span><br><span class="line"><span class="number">2015</span><span class="number">-11</span><span class="number">-02</span> <span class="number">16</span>:<span class="number">09</span>:<span class="number">13</span>,<span class="number">818</span> INFO sqlalchemy.engine.base.Engine SELECT users.id AS users_id, users.name AS users_name, users.fullname AS users_fullname, users.password AS users_password</span><br><span class="line">FROM users</span><br><span class="line">WHERE users.fullname = ?</span><br><span class="line"><span class="number">2015</span><span class="number">-11</span><span class="number">-02</span> <span class="number">16</span>:<span class="number">09</span>:<span class="number">13</span>,<span class="number">818</span> INFO sqlalchemy.engine.base.Engine (<span class="string">'cheney'</span>,)</span><br><span class="line">&lt;User(name=<span class="string">'ccc'</span>, fullname=<span class="string">'cheney'</span>, password=<span class="string">'no'</span>)&gt;</span><br></pre></td></tr></table></figure>
<p>用filter()也能实现，filter使用了更加灵活的SQL语言结构。这允许在处理映射类的属性时候更多的利用python的常规操作符：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">for</span> row <span class="keyword">in</span> session.query(User).filter(User.fullname==<span class="string">'cheney'</span>):            </span><br><span class="line"><span class="meta">... </span>    <span class="keyword">print</span> row</span><br><span class="line">...</span><br><span class="line"><span class="number">2015</span><span class="number">-11</span><span class="number">-02</span> <span class="number">16</span>:<span class="number">18</span>:<span class="number">39</span>,<span class="number">058</span> INFO sqlalchemy.engine.base.Engine SELECT users.id AS users_id, users.name AS users_name, users.fullname AS users_fullname, users.password AS users_password</span><br><span class="line">FROM users</span><br><span class="line">WHERE users.fullname = ?</span><br><span class="line"><span class="number">2015</span><span class="number">-11</span><span class="number">-02</span> <span class="number">16</span>:<span class="number">18</span>:<span class="number">39</span>,<span class="number">059</span> INFO sqlalchemy.engine.base.Engine (<span class="string">'cheney'</span>,)</span><br><span class="line">&lt;User(name=<span class="string">'ccc'</span>, fullname=<span class="string">'cheney'</span>, password=<span class="string">'no'</span>)&gt;</span><br></pre></td></tr></table></figure>
<p>Query对象是完全generative，意味着大部分调用的方法返回的是一个Query对象，这样可以在此基础上增加新的条件。比如查询user的name是”ccc”，fullname是”cheney”，可以通过调用两次filter()完成，相当于两个条件AND的结果：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">for</span> row <span class="keyword">in</span> session.query(User).filter(User.fullname==<span class="string">'cheney'</span>).filter(User.name==<span class="string">'ccc'</span>):</span><br><span class="line"><span class="meta">... </span>    <span class="keyword">print</span> row</span><br><span class="line">...</span><br><span class="line"><span class="number">2015</span><span class="number">-11</span><span class="number">-02</span> <span class="number">16</span>:<span class="number">24</span>:<span class="number">51</span>,<span class="number">982</span> INFO sqlalchemy.engine.base.Engine SELECT users.id AS users_id, users.name AS users_name, users.fullname AS users_fullname, users.password AS users_password</span><br><span class="line">FROM users</span><br><span class="line">WHERE users.fullname = ? AND users.name = ?</span><br><span class="line"><span class="number">2015</span><span class="number">-11</span><span class="number">-02</span> <span class="number">16</span>:<span class="number">24</span>:<span class="number">51</span>,<span class="number">984</span> INFO sqlalchemy.engine.base.Engine (<span class="string">'cheney'</span>, <span class="string">'ccc'</span>)</span><br><span class="line">&lt;User(name=<span class="string">'ccc'</span>, fullname=<span class="string">'cheney'</span>, password=<span class="string">'no'</span>)&gt;</span><br></pre></td></tr></table></figure>
<h2 id="常用筛选操作"><a href="#常用筛选操作" class="headerlink" title="常用筛选操作"></a>常用筛选操作</h2><p>列举一些filter()常用的过滤操作：</p>
<ul>
<li>equals:</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">query.filter(User.name == <span class="string">'ccc'</span>)</span><br></pre></td></tr></table></figure>
<ul>
<li>not equals:</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">query.filter(User.name != <span class="string">'ccc'</span>)</span><br></pre></td></tr></table></figure>
<ul>
<li>LIKE:</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">for</span> row <span class="keyword">in</span> session.query(User).filter(User.fullname.like(<span class="string">'%ene%'</span>)):</span><br><span class="line"><span class="meta">... </span>    <span class="keyword">print</span> row</span><br><span class="line">...</span><br><span class="line"><span class="number">2015</span><span class="number">-11</span><span class="number">-02</span> <span class="number">16</span>:<span class="number">29</span>:<span class="number">13</span>,<span class="number">320</span> INFO sqlalchemy.engine.base.Engine SELECT users.id AS users_id, users.name AS users_name, users.fullname AS users_fullname, users.password AS users_password</span><br><span class="line">FROM users</span><br><span class="line">WHERE users.fullname LIKE ?</span><br><span class="line"><span class="number">2015</span><span class="number">-11</span><span class="number">-02</span> <span class="number">16</span>:<span class="number">29</span>:<span class="number">13</span>,<span class="number">321</span> INFO sqlalchemy.engine.base.Engine (<span class="string">'%ene%'</span>,)</span><br><span class="line">&lt;User(name=<span class="string">'aaa'</span>, fullname=<span class="string">'cheneydc'</span>, password=<span class="string">'123456'</span>)&gt;</span><br><span class="line">&lt;User(name=<span class="string">'ccc'</span>, fullname=<span class="string">'cheney'</span>, password=<span class="string">'no'</span>)&gt;</span><br></pre></td></tr></table></figure>
<ul>
<li>IN:</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">query.filter(User.name.in_([<span class="string">'ccc'</span>, <span class="string">'cheneydc'</span>, <span class="string">'aaa'</span>]))</span><br></pre></td></tr></table></figure>
<ul>
<li>NOT IN:</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">query.filter(~User.name.in_([<span class="string">'ccc'</span>, <span class="string">'cheneydc'</span>, <span class="string">'aaa'</span>]))</span><br><span class="line"></span><br><span class="line"><span class="comment">#example.</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">for</span> row <span class="keyword">in</span> session.query(User).filter(~User.fullname.in_([<span class="string">'cheneydc'</span>, <span class="string">'cheney'</span>])):</span><br><span class="line"><span class="meta">... </span>    <span class="keyword">print</span> row</span><br><span class="line">...</span><br><span class="line"><span class="number">2015</span><span class="number">-11</span><span class="number">-02</span> <span class="number">16</span>:<span class="number">33</span>:<span class="number">49</span>,<span class="number">204</span> INFO sqlalchemy.engine.base.Engine SELECT users.id AS users_id, users.name AS users_name, users.fullname AS users_fullname, users.password AS users_password FROM users</span><br><span class="line">WHERE users.fullname NOT IN (?, ?)</span><br><span class="line"><span class="number">2015</span><span class="number">-11</span><span class="number">-02</span> <span class="number">16</span>:<span class="number">33</span>:<span class="number">49</span>,<span class="number">205</span> INFO sqlalchemy.engine.base.Engine (<span class="string">'cheneydc'</span>, <span class="string">'cheney'</span>)</span><br><span class="line">&lt;User(name=<span class="string">'ed'</span>, fullname=<span class="string">'eeeddd'</span>, password=<span class="string">'qweasd'</span>)&gt;</span><br><span class="line">&lt;User(name=<span class="string">'zxwer'</span>, fullname=<span class="string">'zxcvasdf'</span>, password=<span class="string">'098765'</span>)&gt;</span><br><span class="line">&lt;User(name=<span class="string">'fake'</span>, fullname=<span class="string">'TestUser'</span>, password=<span class="string">'Nopassword'</span>)&gt;</span><br></pre></td></tr></table></figure>
<ul>
<li>IS NULL:</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">query.filter(User.name == <span class="keyword">None</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># alternatively, if pep8/linters are a concern</span></span><br><span class="line">query.filter(User.name.is_(<span class="keyword">None</span>))</span><br></pre></td></tr></table></figure>
<ul>
<li>IS NOT NULL:</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">query.filter(User.name != <span class="keyword">None</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># alternatively, if pep8/linters are a concern</span></span><br><span class="line">query.filter(User.name.isnot(<span class="keyword">None</span>))</span><br></pre></td></tr></table></figure>
<ul>
<li>AND:</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 使用 and_()，这个and_不是python中的and操作符</span></span><br><span class="line"><span class="keyword">from</span> sqlalchemy <span class="keyword">import</span> and_</span><br><span class="line">query.filter(and_(User.name == <span class="string">'ccc'</span>, User.fullname == <span class="string">'cheney'</span>))</span><br><span class="line"></span><br><span class="line"><span class="comment"># 发送多个表达式给.filter()</span></span><br><span class="line">query.filter(User.name == <span class="string">'ccc'</span>, User.fullname == <span class="string">'cheney'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 多次连续调用filter</span></span><br><span class="line">query.filter(User.name == <span class="string">'ccc'</span>).filter(User.fullname == <span class="string">'cheney'</span>)</span><br></pre></td></tr></table></figure>
<ul>
<li>OR:</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 使用or_,这里的or_不是python中的or操作符</span></span><br><span class="line"><span class="keyword">from</span> sqlalchemy <span class="keyword">import</span> or_</span><br><span class="line">query.filter(or_(User.name == <span class="string">'ccc'</span>, User.name == <span class="string">'cheney'</span>))</span><br></pre></td></tr></table></figure>
<ul>
<li>MATCH：</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># match()使用的是数据库的MATCH或CONTAINS方法，依赖于后端的数据库，所以并不是所有数据库都支持，比如SQLite</span></span><br><span class="line">query.filter(User.name.match(<span class="string">'wendy'</span>))</span><br></pre></td></tr></table></figure>
<h2 id="返回列表和标量"><a href="#返回列表和标量" class="headerlink" title="返回列表和标量"></a>返回列表和标量</h2><p>一些Query的方法会立即发出SQL语句并返回一个包含数据库结果的值。这里做简单介绍：</p>
<ul>
<li>all()返回一个列表：</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>query = session.query(User).filter(~User.name.in_([<span class="string">'a'</span>, <span class="string">'b'</span>]))</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>query.all()</span><br><span class="line"><span class="number">2015</span><span class="number">-11</span><span class="number">-02</span> <span class="number">17</span>:<span class="number">38</span>:<span class="number">55</span>,<span class="number">658</span> INFO sqlalchemy.engine.base.Engine SELECT users.id AS users_id, users.name AS users_name, users.fullname AS users_fullname, users.password AS users_password</span><br><span class="line">FROM users</span><br><span class="line">WHERE users.name NOT IN (?, ?)</span><br><span class="line"><span class="number">2015</span><span class="number">-11</span><span class="number">-02</span> <span class="number">17</span>:<span class="number">38</span>:<span class="number">55</span>,<span class="number">659</span> INFO sqlalchemy.engine.base.Engine (<span class="string">'a'</span>, <span class="string">'b'</span>)</span><br><span class="line">[&lt;User(name=<span class="string">'aaa'</span>, fullname=<span class="string">'cheneydc'</span>, password=<span class="string">'123456'</span>)&gt;, &lt;User(name=<span class="string">'ccc'</span>, fullname=<span class="string">'cheney'</span>, password=<span class="string">'no'</span>)&gt;, &lt;User(name=<span class="string">'ed'</span>, fullname=<span class="string">'eeeddd'</span>, password=<span class="string">'qweasd'</span>)&gt;, &lt;User(name=<span class="string">'zxwer'</span>, fullname=<span class="string">'zxcvasdf'</span>, password=<span class="string">'098765'</span>)&gt;, &lt;User(name=<span class="string">'fake'</span>, fullname=<span class="string">'TestUser'</span>, password=<span class="string">'Nopassword'</span>)&gt;]</span><br></pre></td></tr></table></figure>
<ul>
<li>first()将第一个结果作为标量返回：</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>query.first()</span><br><span class="line"><span class="number">2015</span><span class="number">-11</span><span class="number">-02</span> <span class="number">17</span>:<span class="number">40</span>:<span class="number">29</span>,<span class="number">597</span> INFO sqlalchemy.engine.base.Engine SELECT users.id AS users_id, users.name AS users_name, users.fullname AS users_fullname, users.password AS users_password</span><br><span class="line">FROM users</span><br><span class="line">WHERE users.name NOT IN (?, ?)</span><br><span class="line"> LIMIT ? OFFSET ?</span><br><span class="line"><span class="number">2015</span><span class="number">-11</span><span class="number">-02</span> <span class="number">17</span>:<span class="number">40</span>:<span class="number">29</span>,<span class="number">597</span> INFO sqlalchemy.engine.base.Engine (<span class="string">'a'</span>, <span class="string">'b'</span>, <span class="number">1</span>, <span class="number">0</span>)</span><br><span class="line">&lt;User(name=<span class="string">'aaa'</span>, fullname=<span class="string">'cheneydc'</span>, password=<span class="string">'123456'</span>)&gt;</span><br></pre></td></tr></table></figure>

      
    </div>

    
      
      

  <div class="post-copyright">
    <p class="copyright-item">
      <span>原文作者: </span>
      <a href="http://cheneydc.me">Cheney Dong</a>
    </p>
    <p class="copyright-item">
      <span>原文链接: </span>
      <a href="http://cheneydc.me/2015/10/29/sqlalchemy-1/">http://cheneydc.me/2015/10/29/sqlalchemy-1/</a>
    </p>
    <p class="copyright-item">
      <span>许可协议: </span>
      
      <a rel="license" href="http://creativecommons.org/licenses/by-nc/4.0/" target="_blank">知识共享署名-非商业性使用 4.0 国际许可协议</a>
    </p>
  </div>



      
      
    

    
      <footer class="post-footer">
        
        
        
  <nav class="post-nav">
    
      <a class="prev" href="/2015/11/04/amqp-rpc/">
        <i class="iconfont icon-left"></i>
        <span class="prev-text nav-default">openstack中的AMQP & RPC</span>
        <span class="prev-text nav-mobile">上一篇</span>
      </a>
    
    
      <a class="next" href="/2015/10/29/sqlalchemy-2/">
        <span class="next-text nav-default">SQLalchemmy - 2</span>
        <span class="prev-text nav-mobile">下一篇</span>
        <i class="iconfont icon-right"></i>
      </a>
    
  </nav>

      </footer>
    

  </article>


          </div>
          
  <div class="comments" id="comments">
    
      <div id="disqus_thread">
        <noscript>
          Please enable JavaScript to view the
          <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a>
        </noscript>
      </div>
    
  </div>


        </div>
      </main>

      <footer id="footer" class="footer">

  <div class="social-links">
    
      
        
          <a href="mailto:cheneydc@gmail.com" class="iconfont icon-email" title="email"></a>
        
      
    
      
    
      
    
      
    
      
    
      
        
          <a href="https://plus.google.com/u/0/+CheneyDong" class="iconfont icon-google" title="google"></a>
        
      
    
      
        
          <a href="https://github.com/cheneydc" class="iconfont icon-github" title="github"></a>
        
      
    
      
    
      
    
      
    
      
    
      
    
      
    
    
    
      
      <a href="/atom.xml" class="iconfont icon-rss" title="rss"></a>
    
  </div>


<div class="copyright">
  <span class="power-by">
    由 <a class="hexo-link" href="https://hexo.io/">Hexo</a> 强力驱动
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    主题 - 
    <a class="theme-link" href="https://github.com/ahonn/hexo-theme-even">Even</a>
  </span>

  <span class="copyright-year">
    
    &copy; 
     
      2017 - 
    
    2018

    <span class="heart">
      <i class="iconfont icon-heart"></i>
    </span>
    <span class="author">Cheney Dong</span>
  </span>
</div>

      </footer>

      <div class="back-to-top" id="back-to-top">
        <i class="iconfont icon-up"></i>
      </div>
    </div>

    
  
  <script type="text/javascript">
    var disqus_config = function () {
        this.page.url = 'http://cheneydc.me/2015/10/29/sqlalchemy-1/';
        this.page.identifier = '2015/10/29/sqlalchemy-1/';
        this.page.title = 'SQLalchemmy - 1';
    };
    (function() {
    var d = document, s = d.createElement('script');

    s.src = '//cheneydc.disqus.com/embed.js';

    s.setAttribute('data-timestamp', +new Date());
    (d.head || d.body).appendChild(s);
    })();  
  </script>

  

  



    
  





  
    <script type="text/javascript" src="/lib/jquery/jquery-3.1.1.min.js"></script>
  

  
    <script type="text/javascript" src="/lib/slideout/slideout.js"></script>
  

  
    <script type="text/javascript" src="/lib/fancybox/jquery.fancybox.pack.js"></script>
  


    <script type="text/javascript" src="/js/src/even.js?v=2.6.0"></script>
<script type="text/javascript" src="/js/src/bootstrap.js?v=2.6.0"></script>

  </body>
</html>
